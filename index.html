<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Saarthi - Voice-First UPI Wallet</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    body { font-family: 'Inter', sans-serif; touch-action: manipulation; }
    .assistant-bubble { animation: fadeIn 0.45s ease-in-out; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(8px)} to {opacity:1; transform:none} }
    .mic-active { animation: pulse 1.6s infinite; }
    @keyframes pulse { 0%{ box-shadow:0 0 0 0 rgba(255,255,255,0.35) } 70%{ box-shadow:0 0 0 18px rgba(255,255,255,0) } 100%{ box-shadow:0 0 0 0 rgba(255,255,255,0) } }
    #qr-scanner-container { position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:100; }
    #qr-scanner-region { width:80%; max-width:420px; background:#fff; border-radius:1rem; overflow:hidden; }
    .option-card { transition: all .18s ease-in-out; }
    .option-card.highlight { transform: scale(1.04); background-color:#4f46e5; color:#fff; }
    /* small admin / auth panel */
    #auth-panel { position: fixed; top: 12px; right: 12px; background: rgba(255,255,255,0.06); padding: 10px; border-radius: 8px; z-index: 150; }
    .small-btn { padding: 6px 10px; border-radius: 6px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.06); cursor:pointer; }
    .hidden { display:none; }
  </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-between min-h-screen p-4 overflow-hidden">

  <!-- Auth / Admin Panel -->
  <div id="auth-panel">
    <div id="user-info" class="text-sm text-gray-300 mb-2">Not signed in</div>
    <div class="flex gap-2">
      <button id="google-signin-btn" class="small-btn">Sign in (Google)</button>
      <button id="signout-btn" class="small-btn hidden">Sign out</button>
      <button id="anon-signin-btn" class="small-btn">Continue anonymously</button>
    </div>
  </div>

  <!-- Header -->
  <header class="w-full max-w-md mx-auto text-center">
    <h1 class="text-3xl font-bold text-indigo-400">Saarthi</h1>
    <p class="text-gray-400">Your Voice-Powered Wallet</p>
  </header>

  <!-- Main -->
  <main id="main-content" class="w-full max-w-md mx-auto flex flex-col items-center justify-center flex-grow space-y-6">
    <div id="assistant-bubble" class="assistant-bubble bg-indigo-600 p-4 rounded-xl shadow-lg text-center">
      <p id="assistant-text" class="text-lg font-medium">Welcome to Saarthi! Please say 1, 2, or 3.</p>
    </div>

    <div id="options-container" class="w-full grid grid-cols-1 md:grid-cols-3 gap-4">
      <div id="option-qr" class="option-card bg-gray-800 p-4 rounded-lg text-center border-2 border-gray-700">
        <i class="fas fa-qrcode text-4xl mb-2"></i>
        <p class="font-semibold">1. QR Code</p>
      </div>
      <div id="option-saved" class="option-card bg-gray-800 p-4 rounded-lg text-center border-2 border-gray-700">
        <i class="fas fa-save text-4xl mb-2"></i>
        <p class="font-semibold">2. Saved UPI ID</p>
      </div>
      <div id="option-new" class="option-card bg-gray-800 p-4 rounded-lg text-center border-2 border-gray-700">
        <i class="fas fa-plus-circle text-4xl mb-2"></i>
        <p class="font-semibold">3. New UPI ID</p>
      </div>
    </div>

    <div id="user-input-display" class="w-full h-12 bg-gray-800 rounded-lg flex items-center justify-center text-gray-400 italic text-center px-4 hidden">
      <p id="user-text"></p>
    </div>

    <!-- Small management UI: saved contacts preview -->
    <div id="saved-contacts-preview" class="w-full bg-gray-800 rounded-lg p-3 hidden">
      <div class="flex items-center justify-between mb-2">
        <div class="font-medium">Saved Contacts</div>
        <button id="refresh-contacts" class="small-btn">Refresh</button>
      </div>
      <div id="contacts-list" class="text-sm text-gray-300">No contacts loaded</div>
    </div>
  </main>

  <!-- Footer / Mic -->
  <footer class="w-full max-w-md mx-auto flex flex-col items-center py-4">
    <button id="mic-btn" class="bg-indigo-600 text-white rounded-full w-20 h-20 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
      <i class="fas fa-microphone text-3xl"></i>
    </button>
    <p id="mic-status" class="text-gray-400 mt-2">Tap to Speak</p>
  </footer>

  <!-- QR Modal -->
  <div id="qr-scanner-container">
    <div id="qr-scanner-region" style="width:80%; max-width:420px;"></div>
  </div>

  <!-- FIREBASE COMPAT SDKs (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-analytics-compat.js"></script>

  <script>
    /************* Your web app's Firebase configuration *************/
    const firebaseConfig = {
      apiKey: "AIzaSyCZkiWs_SVQnj5ah56XYf5_j8xFs5qdd5I",
      authDomain: "saarthi-91c04.firebaseapp.com",
      projectId: "saarthi-91c004",
      storageBucket: "saarthi-91c04.firebasestorage.app",
      messagingSenderId: "666512915483",
      appId: "1:666512915483:web:c1a6fa0bd586f7a8f88cbe",
      measurementId: "G-6HLDSYZZ38"
    };

    // Initialize Firebase (compat)
    const app = firebase.initializeApp(firebaseConfig);
    const analytics = firebase.analytics ? firebase.analytics() : null;
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    /*************** Helper: UI elements ***************/
    const micBtn = document.getElementById('mic-btn');
    const assistantText = document.getElementById('assistant-text');
    const userText = document.getElementById('user-text');
    const userInputDisplay = document.getElementById('user-input-display');
    const micStatus = document.getElementById('mic-status');
    const optionsContainer = document.getElementById('options-container');
    const qrScannerContainer = document.getElementById('qr-scanner-container');
    const qrScannerRegion = document.getElementById('qr-scanner-region');
    const googleSignInBtn = document.getElementById('google-signin-btn');
    const signoutBtn = document.getElementById('signout-btn');
    const anonSigninBtn = document.getElementById('anon-signin-btn');
    const userInfoEl = document.getElementById('user-info');
    const contactsPreview = document.getElementById('saved-contacts-preview');
    const contactsListEl = document.getElementById('contacts-list');
    const refreshContactsBtn = document.getElementById('refresh-contacts');

    /*************** App state ***************/
    let listening = false;
    let currentStage = 'initial'; // initial, qr-scan, ask-amount, saved-who, new-who, confirm-payment
    let paymentDetails = { method: null, target: null, amount: null };
    let html5QrCode = null;
    let localSavedContacts = {}; // cached from Firestore for the signed-in user

    /*************** Speech Recognition & Synthesis ***************/
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) { recognition.continuous = false; recognition.lang = 'en-IN'; recognition.interimResults = false; }
    const synth = window.speechSynthesis;

    function speak(text, autoListenAfter = false) {
      if (listening && recognition) recognition.stop();
      if (synth.speaking) synth.cancel();
      assistantText.textContent = text;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-IN';
      utter.rate = 0.95;
      utter.onend = () => { if (autoListenAfter) toggleListen(); };
      synth.speak(utter);
    }

    /*************** Firebase Auth helpers ***************/
    googleSignInBtn.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => {
        console.error('Sign-in error', err.message);
        // Avoid using alert()
        speak(`Sign in error: ${err.message}`);
      });
    });

    anonSigninBtn.addEventListener('click', () => {
      auth.signInAnonymously().catch(err => {
         console.error('Anon sign-in error', err.message);
         speak(`Anonymous sign in error: ${err.message}`);
      });
    });

    signoutBtn.addEventListener('click', () => auth.signOut());

    auth.onAuthStateChanged(user => {
      if (user) {
        const isAnon = user.isAnonymous;
        const display = isAnon ? `Anonymous user` : (user.displayName || user.email);
        userInfoEl.textContent = `Signed in: ${display}`;
        googleSignInBtn.classList.add('hidden');
        anonSigninBtn.classList.add('hidden');
        signoutBtn.classList.remove('hidden');

        // load user's saved contacts from Firestore
        loadSavedContacts();
      } else {
        userInfoEl.textContent = 'Not signed in';
        googleSignInBtn.classList.remove('hidden');
        anonSigninBtn.classList.remove('hidden');
        signoutBtn.classList.add('hidden');
        localSavedContacts = {};
        contactsPreview.classList.add('hidden');
      }
    });

    /*************** Firestore functions ***************/
    // User documents located at collection 'users' doc uid
    function userDocRef() {
      const user = auth.currentUser;
      if (!user) {
        console.error("Attempted to get userDocRef, but user is not signed in.");
        // We throw an error here because subsequent functions depend on this.
        // The UI flow should prevent this from being called if not signed in.
        throw new Error('Not signed in');
      }
      return db.collection('users').doc(user.uid);
    }

    async function loadSavedContacts() {
      if (!auth.currentUser) {
         console.log("User not signed in. Cannot load contacts.");
         return;
      }
      try {
        const docRef = userDocRef();
        const contactsCol = await docRef.collection('contacts').get();
        localSavedContacts = {};
        contactsCol.forEach(d => {
          localSavedContacts[d.id] = d.data().upi;
        });
        renderContactsPreview();
      } catch (err) {
        console.error('loadSavedContacts error:', err);
        // This might fail if security rules are not set
        if (err.code === 'permission-denied') {
            speak("I couldn't load your contacts. Please make sure you are signed in and the app has permission.");
        }
      }
    }

    function renderContactsPreview() {
      const keys = Object.keys(localSavedContacts);
      if (!keys.length) {
        contactsListEl.innerText = 'No saved contacts yet.';
        contactsPreview.classList.remove('hidden');
        return;
      }
      contactsPreview.classList.remove('hidden');
      contactsListEl.innerHTML = keys.map(k => `<div class="flex justify-between"><span>${k}</span><span class="text-gray-400">${localSavedContacts[k]}</span></div>`).join('');
    }

    async function saveContactToFirestore(name, upi) {
       if (!auth.currentUser) {
         speak("You must be signed in to save a contact.");
         return;
      }
      try {
        const docRef = userDocRef();
        await docRef.collection('contacts').doc(name.toLowerCase()).set({ upi });
        await loadSavedContacts();
      } catch (err) {
        console.error('saveContactToFirestore error', err);
        speak("I couldn't save the contact. Please try again.");
      }
    }

    async function savePaymentToFirestore(payment) {
      // payment: { target, amount, method, timestamp }
      if (!auth.currentUser) {
         console.log("User not signed in. Payment will not be recorded.");
         // We can allow the flow to continue, just won't save.
         return; 
      }
      try {
        const docRef = userDocRef();
        const paymentsCol = docRef.collection('payments');
        await paymentsCol.add(payment);
      } catch (err) {
        console.error('savePaymentToFirestore error', err);
        // Don't interrupt the user flow, just log the error.
      }
    }

    /*************** Storage function (example: upload receipt) ***************/
    async function uploadReceiptFile(file) {
      if (!auth.currentUser) {
         speak("You must be signed in to upload a file.");
         throw new Error('Not signed in');
      }
      try {
        const user = auth.currentUser;
        const path = `receipts/${user.uid}/${Date.now()}_${file.name}`;
        const snap = await storage.ref(path).put(file);
        return await snap.ref.getDownloadURL();
      } catch (err) {
        console.error('uploadReceiptFile error', err);
        speak("There was an error uploading the file.");
        throw err;
      }
    }

    /*************** App logic (voice flow) ***************/
    function startApp() {
      const welcomeMessage = "Welcome to Saarthi! How would you like to pay? Say 1 for QR Code, 2 for Saved UPI, or 3 for New UPI.";
      assistantText.textContent = "Welcome to Saarthi! Please say 1, 2, or 3.";
      // Wait for any auth state changes to settle first
      setTimeout(() => {
        speak(welcomeMessage, true);
      }, 500);
    }

    function toggleListen() {
      if (!recognition) { 
        micStatus.textContent = "Speech Recognition not supported."; 
        console.error("Speech Recognition not supported in this browser.");
        return; 
      }
      if (synth.speaking) synth.cancel();
      if (listening) { 
        recognition.stop(); 
        return; 
      }
      lastError = "";
      try {
        recognition.start();
      } catch (e) {
        console.error("recognition.start() error", e);
        micStatus.textContent = "Error starting mic.";
      }
    }

    let lastError = '';

    function handleCommand(command) {
      userInputDisplay.classList.remove('hidden');
      userText.textContent = `You said: "${command}"`;
      switch (currentStage) {
        case 'initial': return handleInitialChoice(command);
        case 'ask-amount': return handleAmount(command);
        case 'saved-who': return handleSavedContact(command);
        case 'new-who': return handleNewContact(command);
        case 'confirm-payment': return handleConfirmation(command);
      }
    }

    function highlightOption(optionId) {
      document.querySelectorAll('.option-card').forEach(card => card.classList.remove('highlight'));
      if (optionId) document.getElementById(optionId).classList.add('highlight');
    }

    function handleInitialChoice(command) {
      if (command.includes('1') || command.includes('one')) {
        paymentDetails.method = 'QR Code';
        highlightOption('option-qr');
        const text = "Opening the QR Code scanner. Please point your camera at the QR code.";
        assistantText.textContent = text;
        speak(text);
        startQrScan();
      } else if (command.includes('2') || command.includes('two')) {
        paymentDetails.method = 'Saved UPI';
        highlightOption('option-saved');
        // Ensure user signed in
        if (!auth.currentUser) {
          speak("Please sign in first to access saved contacts. Use the Sign in button on the top-right.", false);
          resetAppFlow(); // Reset to initial state
          return;
        }
        currentStage = 'saved-who';
        const text = "Okay. Which saved contact would you like to pay? Say their name.";
        assistantText.textContent = text;
        speak(text, true);
      } else if (command.includes('3') || command.includes('three')) {
        paymentDetails.method = 'New UPI';
        highlightOption('option-new');
        currentStage = 'new-who';
        const text = "Please say the full UPI ID you want to pay, for example, user at bank.";
        assistantText.textContent = text;
        speak(text, true);
      } else {
        const text = "Sorry, I didn't get that. Please say 1, 2 or 3.";
        speak(text, true);
      }
    }

    function handleSavedContact(command) {
      // try to match with cached contacts
      const lower = command.toLowerCase().trim();
      let contactName = Object.keys(localSavedContacts).find(n => lower.includes(n));
      if (contactName) {
        paymentDetails.target = localSavedContacts[contactName];
        currentStage = 'ask-amount';
        const text = `Okay, paying ${contactName}. How much should I send?`;
        assistantText.textContent = text;
        speak(text, true);
      } else {
        speak("I couldn't find that saved contact. Say the exact saved name.", true);
      }
    }

    const upiRegex = /[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}/;
    function handleNewContact(command) {
      // normalize common speech tokens like "at the rate" or "at"
      const cleaned = command.toLowerCase().replace(/\s+/g, '').replace(/at the rate|attherate|at/g, '@');
      if (upiRegex.test(cleaned)) {
        paymentDetails.target = cleaned;
        currentStage = 'ask-amount';
        const text = `Got it. Paying ${cleaned}. How much money should I send?`;
        assistantText.textContent = text;
        speak(text, true);
      } else {
        speak("That doesn't look like a valid UPI ID. Please say it again clearly, for example, user at bank.", true);
      }
    }

    function handleAmount(command) {
      const match = command.match(/\d+/);
      if (match) {
        paymentDetails.amount = parseInt(match[0], 10);
        currentStage = 'confirm-payment';
        const text = `I will send ${paymentDetails.amount} rupees to ${paymentDetails.target}. Say yes to confirm.`;
        assistantText.textContent = text;
        speak(text, true);
      } else {
        speak("Sorry, I didn't catch an amount. Please say a number, like 50 rupees.", true);
      }
    }

    function handleConfirmation(command) {
      if (command.includes('yes') || command.includes('confirm') || command.includes('correct')) {
        processPayment();
      } else {
        const text = "Okay, transaction cancelled. Let's start over.";
        assistantText.textContent = text;
        speak(text);
        setTimeout(resetApp, 1500);
      }
    }

    async function processPayment() {
      const text = `Sending ${paymentDetails.amount} rupees to ${paymentDetails.target}.`;
      assistantText.textContent = text;
      speak(text);

      // Simulate real payment by saving a record to Firestore (payments collection).
      const paymentRecord = {
        target: paymentDetails.target,
        amount: paymentDetails.amount,
        method: paymentDetails.method,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        // We save the payment regardless of error, as the user flow should complete.
        // The save function itself handles the auth check.
        await savePaymentToFirestore(paymentRecord);
        
        // On success show UI feedback
        setTimeout(() => {
          const successText = 'Payment recorded successfully!';
          assistantText.innerHTML = `<i class="fas fa-check-circle text-green-400 text-4xl mb-2"></i><br>${successText}`;
          speak(successText);
          setTimeout(resetApp, 1800);
        }, 1000);
      } catch (err) {
        // This catch is mostly for unexpected errors, as savePaymentToFirestore handles its own.
        console.error('processPayment error', err);
        speak('There was an error saving the payment. Try again later.');
        setTimeout(resetApp, 1500);
      }
    }
    
    // Resets just the payment flow logic, not the whole page
    function resetAppFlow() {
        currentStage = 'initial';
        paymentDetails = { method: null, target: null, amount: null };
        highlightOption(null);
        userInputDisplay.classList.add('hidden');
        userText.textContent = '';
        if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop().catch(()=>{});
        qrScannerContainer.style.display = 'none';
    }

    function resetApp() {
      resetAppFlow();
      startApp();
    }

    /*************** QR scanner (same as earlier) ***************/
    function startQrScan() {
      qrScannerContainer.style.display = 'flex';
      if (typeof Html5Qrcode === 'undefined') {
        speak('QR Scanner library not loaded.');
        qrScannerContainer.style.display = 'none';
        resetAppFlow();
        return;
      }
      if (!html5QrCode) {
        try {
            html5QrCode = new Html5Qrcode("qr-scanner-region");
        } catch (e) {
            console.error("Could not instantiate Html5Qrcode", e);
            speak('Error initializing QR scanner.');
            qrScannerContainer.style.display = 'none';
            resetAppFlow();
            return;
        }
      }
      
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };
      
      const qrCodeSuccessCallback = (decodedText) => {
        if (html5QrCode && html5QrCode.isScanning) {
          html5QrCode.stop().then(() => {
            qrScannerContainer.style.display = 'none';
            paymentDetails.target = decodedText; // We assume the decoded text is the UPI ID
            currentStage = 'ask-amount';
            const text = `Scan successful. How much money should I send?`;
            assistantText.textContent = text;
            speak(text, true);
          }).catch(err => {
            console.error('stop scanner error', err);
            qrScannerContainer.style.display = 'none';
            resetAppFlow();
          });
        }
      };

      Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
          html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .catch(err => {
              console.error('start scanner error', err);
              speak('Error starting scanner. Please try again.');
              qrScannerContainer.style.display = 'none';
              resetAppFlow();
            });
        } else {
          speak('No camera found on this device.');
          qrScannerContainer.style.display = 'none';
          resetAppFlow();
        }
      }).catch(err => {
        console.error('camera permission error', err);
        speak('Camera permission denied or not available. Grant permission in browser settings.');
        qrScannerContainer.style.display = 'none';
        resetAppFlow();
      });
    }

    /*************** Speech recognition events ***************/
    if (recognition) {
      recognition.onstart = () => {
        listening = true; micBtn.classList.add('mic-active'); micStatus.textContent = 'Listening...';
      };
      recognition.onend = () => {
        listening = false; micBtn.classList.remove('mic-active');
        if (lastError && lastError !== 'no-speech') micStatus.textContent = 'Error. Tap to speak.';
        else if (lastError === 'no-speech') micStatus.textContent = "I didn't hear you. Tap to speak.";
        else micStatus.textContent = 'Tap to Speak';
        lastError = '';
      };
      recognition.onresult = (event) => {
        lastError = '';
        const command = event.results[0][0].transcript.toLowerCase().trim();
        handleCommand(command);
      };
      recognition.onerror = (event) => {
        lastError = event.error;
        if (event.error === 'no-speech') console.log('no-speech');
        else console.error('recognition error', event.error);
      };
    }

    micBtn.addEventListener('click', toggleListen);
    refreshContactsBtn.addEventListener('click', loadSavedContacts);

    // Auto start
    window.onload = () => { 
        // We let onAuthStateChanged handle the first load
        // and then startApp is called from there.
        // Adding a fallback just in case.
        setTimeout(startApp, 800); 
    };

  </script>
</body>
</html>
